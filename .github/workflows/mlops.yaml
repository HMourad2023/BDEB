name: CI/CD for Streamlit App

on:
  push:
    branches:
      - main

jobs:
  run:
    runs-on: ubuntu-20.04  # Utilisation de l'image Ubuntu 20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Update system libraries
        run: |
          sudo apt-get update
          sudo apt-get install openssl -y
          sudo apt-get install --reinstall libssl-dev

      - name: Upgrade DVC and install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade dvc[dvc-gdrive] mlflow -r requirements.txt

      - name: Create DVC Google Drive configuration file
        run: |
          echo '{
            "web": {
              "client_id": "${{ secrets.CLIENT_ID }}",
              "project_id": "${{ secrets.PROJECT_ID }}",
              "auth_uri": "${{ secrets.AUTH_URI }}",
              "token_uri": "${{ secrets.TOKEN_URI }}",
              "auth_provider_x509_cert_url": "${{ secrets.AUTH_PROVIDER_X509_CERT_URL }}",
              "client_secret": "${{ secrets.CLIENT_SECRET }}"
            }
          }' > gdrive_service_account.json

      - name: Configure DVC remote for Google Drive
        run: |
          dvc remote modify myremote gdrive_service_account_json_file_path gdrive_service_account.json

      - name: Pull DVC data
        run: |
          dvc fetch
          dvc repro

      - name: Set up MLflow
        run: |
          mlflow server --backend-store-uri sqlite:///mlflow.db --default-artifact-root ./mlruns &

      - name: Train and log models
        run: |
          python src/components/train_and_log_model.py

      - name: Register the best model
        env:
          MLFLOW_TRACKING_URI: "http://127.0.0.1:5000"
        run: |
          python src/register_best_model.py

      - name: Clean up
        run: |
          rm gdrive_service_account.json  # Nettoyage du fichier temporaire
